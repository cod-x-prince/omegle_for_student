<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CampusConnect - Dashboard</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <!-- Animated Background -->
    <div class="animated-bg">
      <div class="bg-particle"></div>
      <div class="bg-particle"></div>
      <div class="bg-particle"></div>
      <div class="bg-particle"></div>
      <div class="bg-particle"></div>
    </div>

    <!-- Floating Navigation -->
    <nav class="floating-nav">
      <div class="nav-brand">
        <span class="logo-icon">🎓</span>
        <span class="logo-text">CampusConnect</span>
      </div>
      <div class="nav-links">
        <span class="nav-link" id="user-email">Loading...</span>
        <div class="security-badge" id="security-badge">🔒 Standard</div>
        <button id="security-settings-btn" class="nav-btn">Security</button>
        <button id="logout-btn" class="nav-btn">Logout</button>
      </div>
    </nav>

    <!-- Security Settings Modal -->
    <div id="securityModal" class="modal" style="display: none">
      <div class="modal-content security-modal">
        <div class="modal-header">
          <h3>Security Settings</h3>
          <button class="modal-close" id="closeSecurityModal">×</button>
        </div>
        <div class="modal-body">
          <div class="security-section">
            <h4>🔐 Two-Factor Authentication</h4>
            <div class="security-status" id="mfaStatus">
              <span class="status-badge disabled">Disabled</span>
              <button id="enableMfaBtn" class="btn-primary small">
                Enable 2FA
              </button>
            </div>
            <p class="security-description">
              Protect your account with an extra layer of security. Requires an
              authenticator app.
            </p>
          </div>

          <div class="security-section">
            <h4>🔒 Encryption Status</h4>
            <div class="security-status">
              <span class="status-badge enabled">End-to-End Enabled</span>
            </div>
            <p class="security-description">
              All your video calls and messages are encrypted end-to-end.
            </p>
          </div>

          <div class="security-section">
            <h4>📊 Security Level</h4>
            <div class="security-level">
              <div class="level-indicator">
                <div class="level-bar">
                  <div class="level-fill" style="width: 70%"></div>
                </div>
                <span class="level-text">Enhanced Security</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MFA Setup Modal -->
    <div id="mfaSetupModal" class="modal" style="display: none">
      <div class="modal-content mfa-modal">
        <div class="modal-header">
          <h3>Setup Two-Factor Authentication</h3>
          <button class="modal-close" id="closeMfaModal">×</button>
        </div>
        <div class="modal-body">
          <div class="mfa-step" id="mfaStep1">
            <h4>Step 1: Scan QR Code</h4>
            <p>Use your authenticator app to scan this QR code:</p>
            <div class="qrcode-container">
              <img id="mfaQrCode" src="" alt="MFA QR Code" />
            </div>
            <div
              class="mfa-backup-codes"
              id="backupCodesList"
              style="display: none"
            >
              <h5>Backup Codes (Save these securely):</h5>
              <div class="codes-list" id="backupCodes"></div>
            </div>
            <button id="showBackupCodes" class="btn-secondary">
              Show Backup Codes
            </button>
          </div>

          <div class="mfa-step" id="mfaStep2" style="display: none">
            <h4>Step 2: Verify Setup</h4>
            <p>Enter the 6-digit code from your authenticator app:</p>
            <div class="form-group">
              <input
                type="text"
                id="mfaVerifyCode"
                placeholder="123456"
                maxlength="6"
              />
            </div>
            <button id="verifyMfaBtn" class="btn-primary">
              Verify & Enable
            </button>
            <button id="backToQr" class="btn-secondary">Back to QR Code</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Dashboard Content -->
    <main class="dashboard-main">
      <div class="container">
        <!-- Welcome Section -->
        <section class="welcome-section">
          <div class="hero-badge">🔒 Secure Connection Active</div>
          <h1 class="hero-title">
            Welcome to Your
            <span class="title-line">Study Hub</span>
          </h1>
          <p class="hero-subtitle">
            Connect with fellow students for collaborative learning sessions.
            All communications are end-to-end encrypted for your privacy.
          </p>
        </section>

        <!-- Security Status Banner -->
        <div class="security-banner" id="securityBanner">
          <div class="banner-content">
            <span class="banner-icon">🔒</span>
            <span class="banner-text"
              >End-to-end encryption active for all connections</span
            >
          </div>
        </div>

        <!-- Quick Actions -->
        <section class="actions-section">
          <div class="action-cards">
            <div class="feature-card video-card">
              <div class="feature-icon">🎥</div>
              <div class="security-badge-card">🔐 Encrypted</div>
              <h3 class="feature-title">Video Study Session</h3>
              <p class="feature-description">
                Connect with another student for a real-time video study
                session. Perfect for group projects and collaborative learning.
              </p>
              <button id="start-video-chat" class="cta-primary large">
                Start Video Chat
              </button>
              <div class="feature-highlight"></div>
            </div>

            <div class="feature-card text-card">
              <div class="feature-icon">💬</div>
              <div class="security-badge-card">🔐 Encrypted</div>
              <h3 class="feature-title">Text Chat Only</h3>
              <p class="feature-description">
                Connect with a study partner for text-based collaboration. Share
                notes, ask questions, and work together in real-time.
              </p>
              <button id="start-text-chat" class="cta-secondary large">
                Start Text Chat
              </button>
              <div class="feature-highlight"></div>
            </div>

            <div class="feature-card security-card">
              <div class="feature-icon">🛡️</div>
              <h3 class="feature-title">Security Center</h3>
              <p class="feature-description">
                Manage your security settings, enable two-factor authentication,
                and view your encryption status.
              </p>
              <button id="openSecurityCenter" class="cta-secondary large">
                Security Settings
              </button>
              <div class="feature-highlight"></div>
            </div>
          </div>
        </section>

        <!-- Stats Section -->
        <section class="stats-section">
          <div class="stats-container">
            <div class="stat-item">
              <div class="stat-icon">⏱️</div>
              <div class="stat-content">
                <div class="stat-number" id="session-count">0</div>
                <div class="stat-label">Study Sessions</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">🤝</div>
              <div class="stat-content">
                <div class="stat-number" id="partner-count">0</div>
                <div class="stat-label">Study Partners</div>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon">🔒</div>
              <div class="stat-content">
                <div class="stat-number" id="security-score">100%</div>
                <div class="stat-label">Security Score</div>
              </div>
            </div>
          </div>
        </section>

        <!-- Recent Activity -->
        <section class="activity-section">
          <h3>Recent Activity & Security Events</h3>
          <div class="activity-list" id="activity-list">
            <div class="activity-item security-activity">
              <span class="activity-icon">🔒</span>
              <span>End-to-end encryption enabled for all sessions</span>
            </div>
            <div class="activity-item">
              <span class="activity-icon">🕒</span>
              <span>Ready to start your first study session!</span>
            </div>
          </div>
        </section>

        <!-- Encryption Status Section -->
        <section class="encryption-section">
          <div class="encryption-status">
            <div class="encryption-icon">🔐</div>
            <div class="encryption-info">
              <h4>End-to-End Encryption Active</h4>
              <p>
                All your video calls and messages are secured with
                military-grade encryption
              </p>
            </div>
            <div class="encryption-badge active">Active</div>
          </div>
        </section>
      </div>
    </main>

    <!-- Connection Status Indicator -->
    <div
      class="connection-indicator"
      id="connection-indicator"
      style="display: none"
    >
      🟢 Connected Securely
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/auth/authManager.js"></script>
    <script src="/js/utils/logger.js"></script>
    <script src="/js/utils/helpers.js"></script>

    <!-- Security Scripts -->
    <script src="/js/auth/mfaManager.js"></script>
    <script src="/js/security/securityManager.js"></script>

    <!-- ADD VIDEO MANAGER SCRIPT HERE - This was missing -->
    <script src="/js/video/videoManager.js"></script>

    <script src="/js/dashboard.js"></script>

    <!-- Add dynamic loading fallback -->
    <script>
      // Fallback: Ensure VideoManager is available
      document.addEventListener("DOMContentLoaded", function () {
        // Check if VideoManager loaded successfully
        setTimeout(() => {
          if (typeof VideoManager === "undefined") {
            console.warn(
              "VideoManager not loaded via script tag, loading dynamically..."
            );

            // Dynamically load VideoManager
            const script = document.createElement("script");
            script.src = "/js/video/videoManager.js";
            script.onload = function () {
              console.log("VideoManager loaded dynamically");
            };
            script.onerror = function () {
              console.error("Failed to load VideoManager dynamically");
            };
            document.head.appendChild(script);
          } else {
            console.log("VideoManager loaded successfully");
          }
        }, 100);
      });
    </script>
  </body>
</html>
