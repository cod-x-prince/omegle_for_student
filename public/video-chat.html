<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CampusConnect - Video Chat</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      /* Add camera permission debugging styles */
      .permission-debug {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 15px;
        margin: 10px 0;
        display: none;
      }
      .permission-debug.visible {
        display: block;
      }
      .debug-info {
        font-family: monospace;
        font-size: 12px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        margin-top: 10px;
      }
      .control-btn.small {
        padding: 5px 10px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Camera Permission Debug -->
    <div id="permissionDebug" class="permission-debug">
      <strong>ðŸ”§ Camera Debug Info:</strong>
      <div id="debugInfo" class="debug-info">
        Checking camera permissions...
      </div>
      <button id="retryCamera" class="control-btn small">Retry Camera</button>
    </div>

    <div class="video-chat-container">
      <!-- Header -->
      <div class="video-chat-header">
        <div>
          <h2>ðŸŽ¥ CampusConnect Video Chat</h2>
          <div class="connection-quality">
            <span>Connection:</span>
            <div class="quality-dot" id="connectionQuality"></div>
            <span id="connectionStatus" class="status waiting"
              >Connecting...</span
            >
          </div>
        </div>
        <div>
          <button id="disconnectBtn" class="control-btn">ðŸ“ž End Call</button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="video-main">
        <!-- Video Section -->
        <div class="video-section">
          <div class="video-container">
            <div class="video-grid">
              <!-- Local Video -->
              <div class="local-video-container">
                <div class="video-label">You</div>
                <video
                  id="localVideo"
                  class="video-element"
                  autoplay
                  muted
                  playsinline
                ></video>
                <div id="local-overlay" class="video-overlay">
                  <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Starting your camera...</p>
                  </div>
                </div>
              </div>

              <!-- Remote Video -->
              <div class="remote-video-container">
                <div class="video-label">Partner</div>
                <video
                  id="remoteVideo"
                  class="video-element"
                  autoplay
                  playsinline
                ></video>
                <div id="remote-overlay" class="video-overlay">
                  <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Waiting for partner...</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Video Controls -->
          <div class="video-controls">
            <button id="toggleVideo" class="control-btn active">
              ðŸŽ¥ Video
            </button>
            <button id="toggleAudio" class="control-btn active">
              ðŸŽ¤ Audio
            </button>
            <button id="switchCamera" class="control-btn">
              ðŸ”„ Switch Camera
            </button>
            <button id="fullscreenBtn" class="control-btn">â›¶ Fullscreen</button>
          </div>
        </div>

        <!-- Chat Section -->
        <div class="chat-section">
          <div class="chat-messages" id="chatMessages">
            <div class="message system">
              Welcome to Video Chat! You'll be connected with another student
              shortly.
            </div>
          </div>

          <div class="typing-indicator" id="typingIndicator">
            Partner is typing...
          </div>

          <div class="chat-input-container">
            <textarea
              id="messageInput"
              class="message-input"
              placeholder="Connecting..."
              rows="1"
              disabled
            ></textarea>
            <button id="sendButton" class="send-button" disabled>âž¤</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Load VideoManager FIRST -->
    <script>
      // Global VideoManager availability check
      window.VideoManagerAvailable = false;

      // Create a simple VideoManager loader
      function loadVideoManager() {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "/js/video/videoManager.js";
          script.onload = () => {
            console.log("VideoManager script loaded successfully");
            window.VideoManagerAvailable = true;
            resolve();
          };
          script.onerror = () => {
            console.error("Failed to load VideoManager script");
            reject(new Error("VideoManager script failed to load"));
          };
          document.head.appendChild(script);
        });
      }
    </script>

    <!-- Load the main app AFTER VideoManager -->
    <script src="/js/video/videoChatApp.js"></script>

    <!-- Camera Permission Debug Script -->
    <script>
      // Camera permission debugging
      async function debugCameraAccess() {
        const debugInfo = document.getElementById("debugInfo");
        const permissionDebug = document.getElementById("permissionDebug");

        try {
          debugInfo.innerHTML = "ðŸ” Checking browser support...";

          // Check if getUserMedia is supported
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error("getUserMedia is not supported in this browser");
          }

          debugInfo.innerHTML += "\nâœ… getUserMedia is supported";

          // List available devices
          const devices = await navigator.mediaDevices.enumerateDevices();
          const videoDevices = devices.filter(
            (device) => device.kind === "videoinput"
          );
          const audioDevices = devices.filter(
            (device) => device.kind === "audioinput"
          );

          debugInfo.innerHTML += `\nðŸ“¹ Video devices: ${videoDevices.length}`;
          debugInfo.innerHTML += `\nðŸŽ¤ Audio devices: ${audioDevices.length}`;

          if (videoDevices.length === 0) {
            throw new Error("No camera found on this device");
          }

          // Test camera access with simple constraints
          debugInfo.innerHTML += "\nðŸ” Testing camera access...";
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });

          debugInfo.innerHTML += "\nâœ… Camera access successful!";
          debugInfo.innerHTML += `\nðŸŽ¬ Video tracks: ${
            stream.getVideoTracks().length
          }`;
          debugInfo.innerHTML += `\nðŸŽµ Audio tracks: ${
            stream.getAudioTracks().length
          }`;

          // Show success and hide debug panel
          setTimeout(() => {
            permissionDebug.classList.remove("visible");
          }, 3000);

          // Clean up test stream
          stream.getTracks().forEach((track) => track.stop());

          return true;
        } catch (error) {
          debugInfo.innerHTML += `\nâŒ Error: ${error.message}`;
          debugInfo.innerHTML += `\nðŸ’¡ Solution: Check browser permissions and ensure you're using HTTPS`;
          permissionDebug.classList.add("visible");
          return false;
        }
      }

      // Retry camera button
      document
        .getElementById("retryCamera")
        ?.addEventListener("click", debugCameraAccess);

      // Run debug on page load and ensure VideoManager loads
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("VideoChat: DOM loaded, initializing...");

        try {
          // Load VideoManager first
          await loadVideoManager();
          console.log("VideoManager loaded successfully");

          // Test camera access
          await debugCameraAccess();
        } catch (error) {
          console.error("Failed to initialize VideoChat:", error);
          document.getElementById("connectionStatus").textContent =
            "Failed to load video components";
        }
      });
    </script>
  </body>
</html>
